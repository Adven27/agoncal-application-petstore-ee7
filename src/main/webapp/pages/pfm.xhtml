<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/basic.xhtml">

    <ui:define name="pageTitle">
        <h:outputText value="PFM"/>
    </ui:define>

    <ui:define name="mainPageContent">
        <div class="container">
            <script>
                var TextFit = function () {
                    var container = $('#chart');
                    container.each(function () {
                        var container_width = $(this).width(),
                            width_offset = 10,
                            font_container = $(this).find('#chart-total');
                        var originalTxt = font_container.text();
                        font_container.text(originalTxt.replace(/ /g, "_"));

                        if (width_offset > 0) {
                            container_width -= width_offset;
                        }

                        font_container.each(function () {
                            var font_container_width = $(this).width(),
                                font_size = parseFloat($(this).css('font-size')),
                                diff = 0;

                            if (container_width > font_container_width) {
                                diff = container_width - font_container_width;
                            } else if (container_width &lt; font_container_width) {
                                diff = font_container_width - container_width;
                            }

                            var diff_percentage = Math.round((diff / Math.max(container_width, font_container_width)) * 100);

                            if (diff_percentage !== 0) {
                                if (container_width > font_container_width) {
                                    new_font_size = font_size + Math.round((font_size / 100) * diff_percentage);
                                } else if (container_width &lt; font_container_width) {
                                    new_font_size = font_size - Math.round((font_size / 100) * diff_percentage);
                                }
                            }
                            $(this).css('font-size', (new_font_size - 10) + 'px');
                            font_container.text(originalTxt);
                        });
                    });
                };

                function extLegend() {
                    this.cfg.seriesDefaults.rendererOptions = {
                        showDataLabels: false,
                        showDataCategoryOnHover: true,
                        sliceMargin: 1,
                        ringMargin: 8,
                        thickness: 15,
                        startAngle: 0,
                        padding: 10
                    };
                    this.cfg.legend = {
                        show: false
                    };
                    this.cfg.grid = {
                        shadow: false,
                        drawBorder: false,
                        background: "transparent",
                        shadowColor: "transparent"
                    };
                    this.cfg.highlighter = {
                        show: true,
                        tooltipLocation: "se",
                        useAxesFormatters: false
                    };

                    var total = $('#chart-total');
                    total.css('top', (total.parent().height() / 2 - 50) + 'px');
                    total.css('left', '45px'/*total.parent().width()/2*/);

                    TextFit();
                }

            </script>
            <div class="row">
                <div class="col-lg-1 hidden-sm hidden-md"/>
                <div class="col-lg-10 col-sm-12">
                    <div class="container-embedded panel panel--content">
                        <h2 class="text text--normal">
                            <h:outputText value="#{msg['page.pfm.pageHeader']}"/>
                        </h2>

                        <div class="separator separator--header"/>

                        <div class="container-embedded container--row">
                            <div class="row">
                                <div>
                                    <h:form id="filter">
                                        <p:growl id="growl" showDetail="true"/>
                                        <div class="ui-g">
                                            <div class="ui-g-4"/>
                                            <div class="ui-g-4 ui-md-4">
                                                <p:outputLabel for="product" value="Card"/>
                                                <p:selectOneMenu id="product" value="#{pfmView.filter.product}"
                                                                 style="width: 100%" label="Card"
                                                                 autoWidth="false">
                                                    <f:selectItems value="#{pfmView.products}"/>
                                                    <p:ajax event="change" listener="#{pfmView.changeProduct}"
                                                            update="data"/>
                                                </p:selectOneMenu>
                                            </div>
                                            <div class="ui-g-2 ui-md-2">
                                                <p:outputLabel for="fromDate" value="From"/>
                                                <p:calendar id="fromDate" value="#{pfmView.filter.from}"
                                                            inputStyle="width: 100%;"
                                                            label="from"
                                                            pattern="dd.MM.yyyy"
                                                            maxdate="#{pfmView.filter.to}">
                                                    <p:ajax event="dateSelect" global="false" process="@this"
                                                            listener="#{pfmView.changeProduct}"
                                                            update="data"/>
                                                </p:calendar>
                                            </div>
                                            <div class="ui-g-2 ui-md-2">
                                                <p:outputLabel for="toDate" value="To"/>
                                                <p:calendar id="toDate" value="#{pfmView.filter.to}"
                                                            inputStyle="width: 100%;"
                                                            label="to"
                                                            pattern="dd.MM.yyyy"
                                                            mindate="#{pfmView.filter.from}">
                                                    <p:ajax event="dateSelect" global="false" process="@this"
                                                            listener="#{pfmView.changeProduct}"
                                                            update="data"/>
                                                </p:calendar>
                                            </div>
                                        </div>
                                        <h:panelGroup layout="block" id="data" class="ui-g">
                                            <div class="ui-g-3">
                                                <h:panelGroup>
                                                    <div id="chart">
                                                        <p:chart type="donut" model="#{pfmView.donut}">
                                                            <p:ajax event="itemSelect" update="growl, transactions"
                                                                    listener="#{pfmView.itemSelect}"/>
                                                        </p:chart>
                                                        <span id="chart-total">#{pfmView.donut.total} #{pfmView.donut.currency}</span>
                                                    </div>
                                                </h:panelGroup>
                                            </div>
                                            <div class="ui-g-3">
                                                <h:panelGroup>
                                                    <h:dataTable id="categories"
                                                                 value="#{pfmView.donut.categoryBreakdown.entrySet()}"
                                                                 var="e"
                                                                 styleClass="it-breakdown"
                                                                 columnClasses="it-cat, it-percent">
                                                        <h:column><h:outputText value="#{e.key}"/></h:column>
                                                        <h:column><h:outputText value="#{e.value}%"/></h:column>
                                                    </h:dataTable>
                                                </h:panelGroup>
                                            </div>
                                            <div class="ui-g-6">
                                                <h:panelGroup>
                                                    <h:dataTable id="transactions"
                                                                 value="#{pfmView.productOperations}"
                                                                 var="trn"
                                                                 rendered="#{not empty pfmView.productOperations}"
                                                                 styleClass="it-transactions table"
                                                                 columnClasses="it-cat, it-sum, it-date">
                                                        <h:column><h:outputText value="#{trn.category}"/></h:column>
                                                        <h:column><h:outputText value="#{trn.amount}"/></h:column>
                                                        <h:column><h:outputText value="#{trn.currency}"/></h:column>
                                                        <h:column><h:outputText value="#{trn.dt}"/></h:column>
                                                    </h:dataTable>
                                                </h:panelGroup>
                                            </div>
                                        </h:panelGroup>
                                    </h:form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-1 hidden-sm hidden-md"/>
            </div>
        </div>
    </ui:define>
</ui:composition>
